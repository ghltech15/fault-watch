---
phase: 02-content-export
plan: 03
type: standard
title: Trigger System & UI Integration
---

# Plan 02-03: Trigger System & UI Integration

## Objective

Implement the trigger system for automated content generation and integrate with the Streamlit dashboard UI.

**Purpose:** Enable automatic content creation based on price alerts, scheduled times, and manual buttons.
**Output:** Working trigger system with UI controls for generating TikTok content.

## Execution Context

@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-export/02-01-SUMMARY.md
@.planning/phases/02-content-export/02-02-SUMMARY.md
@content_generator.py
@fault_watch.py

**Depends on:** 02-01 (infrastructure), 02-02 (video generation)
**User Requirements:** Price thresholds, time-based, manual triggers

## Tasks

<task type="auto">
  <name>Create trigger system module</name>
  <files>content_triggers.py</files>
  <action>
    Create content_triggers.py with:

    1. **TriggerConfig dataclass:**
       - price_thresholds: dict = {
           'silver': [90, 100, 150],  # Generate at these prices
           'ms_drop': [-5, -10, -15],  # MS stock % drops
           'vix': [30, 40, 50],  # VIX spikes
         }
       - scheduled_times: list = ['09:30', '16:00', '21:00']  # Daily summaries
       - enabled: bool = True

    2. **TriggerManager class:**
       - __init__(self, generator: ContentGenerator, config: TriggerConfig)
       - _last_triggered: dict - track what's already triggered (avoid duplicates)
       - check_price_triggers(prices: dict) -> List[Path] - check thresholds, generate content
       - check_scheduled_triggers() -> Optional[Path] - check if time matches
       - manual_generate(template: TemplateType, data: dict) -> Path - on-demand generation
       - get_trigger_status() -> dict - current state of all triggers

    3. **Deduplication logic:**
       - Store last trigger time for each threshold
       - Don't re-trigger same threshold within 1 hour
       - Reset daily for scheduled triggers

    4. **Integration points:**
       - check_price_triggers() called after fetch_all_prices()
       - check_scheduled_triggers() called on each refresh
       - Returns list of generated file paths
  </action>
  <verify>
    python -c "
from content_triggers import TriggerManager, TriggerConfig
from content_generator import ContentGenerator
g = ContentGenerator()
t = TriggerManager(g)
print('TriggerManager initialized')
print(f'Status: {t.get_trigger_status()}')
"
  </verify>
  <done>TriggerManager class with price, scheduled, and manual trigger support</done>
</task>

<task type="auto">
  <name>Add Content Export tab to dashboard</name>
  <files>fault_watch.py</files>
  <action>
    Add new tab "Content" to the dashboard tabs.

    1. **Update tabs list:**
       Add "ðŸ“± Content" as 8th tab after "ðŸ“ˆ Scenarios"

    2. **Create render_content_tab(prices, countdown):**
       Display 3 sections:

       **Section 1: Manual Generation**
       - 4 buttons in a row: "Price Alert", "Countdown", "Bank Crisis", "Daily Summary"
       - Each button generates that template type
       - Show success message with file path after generation
       - Add "Generate Video" toggle (image only vs video)

       **Section 2: Trigger Status**
       - Show current trigger thresholds
       - Display last triggered times
       - Enable/disable toggle for auto-triggers

       **Section 3: Recent Content**
       - List last 5 generated files (images + videos)
       - Show thumbnail preview for images
       - Download buttons for each file

    3. **Wire up content generation:**
       - Import ContentGenerator, TriggerManager
       - Initialize in main() with st.session_state
       - Call trigger checks after price fetch
       - Display any auto-generated content alerts
  </action>
  <verify>
    Run: streamlit run fault_watch.py
    Navigate to Content tab
    Click "Price Alert" button
    Verify image is generated and download available
  </verify>
  <done>Content tab with manual generation buttons and trigger status display</done>
</task>

<task type="auto">
  <name>Integrate auto-triggers with main loop</name>
  <files>fault_watch.py</files>
  <action>
    Wire up automatic content generation in main():

    1. **Initialize trigger system:**
       ```python
       if 'trigger_manager' not in st.session_state:
           st.session_state.trigger_manager = TriggerManager(ContentGenerator())
       ```

    2. **After price fetch, check triggers:**
       ```python
       # Check price triggers
       generated = st.session_state.trigger_manager.check_price_triggers({
           'silver': prices.get('silver', {}).get('price', 0),
           'ms_change': prices.get('morgan_stanley', {}).get('change_pct', 0),
           'vix': prices.get('vix', {}).get('price', 0),
       })
       if generated:
           st.toast(f"ðŸŽ¬ Auto-generated {len(generated)} content files!")
       ```

    3. **Store generated paths in session state:**
       Track for display in Content tab

    4. **Scheduled triggers:**
       Check time-based triggers on each refresh
       Generate daily summary at configured times

    5. **Sidebar indicator:**
       Add small indicator showing trigger system status (enabled/disabled, last generated)
  </action>
  <verify>
    Set silver threshold to current price +1
    Wait for price to cross threshold (or manually test)
    Verify content auto-generates
  </verify>
  <done>Auto-triggers integrated with price fetching and dashboard refresh</done>
</task>

## Verification

Before declaring plan complete:
- [ ] TriggerManager class works with all trigger types
- [ ] Content tab displays in dashboard
- [ ] Manual generation buttons produce files
- [ ] Auto-triggers fire when thresholds crossed
- [ ] Generated files appear in content-output/
- [ ] Download buttons work for generated files
- [ ] No duplicate triggers within cooldown period

## Success Criteria

- Trigger system with price, scheduled, and manual modes
- Content tab integrated into dashboard
- Manual generation with 1-click buttons
- Auto-generation on price thresholds
- Scheduled daily summaries
- Recent content display with downloads
- Phase 2 complete

## Output

After completion, create `.planning/phases/02-content-export/02-03-SUMMARY.md`

Update STATE.md and ROADMAP.md to reflect Phase 2 complete.
